---
- name: Check if all requested repositories are defined in defaults

  vars:
    all_repos: "{{ repos.keys() }}"
    requested_repos: "{{ repo_list | default(all_repos) }}"
  fail:
    msg: "The following requested repositories are not defined in defaults: {{ requested_repos | difference(all_repos) | join(', ') }}. Available repositories are: {{ all_repos | join(', ') }}"
  when: requested_repos | difference(all_repos) | length > 0

- name: Install requested repositories or default to all
  vars:
    repo_subset: "{{ requested_repos }}"

  loop: "{{ repo_subset }}"
  loop_control:
    loop_var: repo_name

  include_tasks: install_repo.yml

  vars:
    key_url: "{{ repos[repo_name].key_url }}"
    repo_url: "{{ repos[repo_name].repo_url }}"
    filename: "{{ repos[repo_name].filename }}"
    repo_name: "{{ repos[repo_name].repo_name }}"
