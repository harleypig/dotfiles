---
# This role downloads a GitHub release

- name: Get the latest release of {{ github_repo }} from GitHub
  uri:
    url: "https://api.github.com/repos/{{ github_repo }}/releases/latest"
    method: GET
    return_content: yes
    status_code: 200
    headers:
      Accept: "application/vnd.github.v3+json"
  register: github_release

-
- name: Fail if nothing found
  fail:
    msg: "No matching asset found for pattern {{ github_asset_pattern }}"
  when: github_release.json.assets | selectattr('name', 'match', github_asset_pattern) | list | count == 0

- name: Set variables
  vars:
    github_download_url: "{{ github_release.json.assets | selectattr('name', 'match', github_asset_pattern) | map(attribute='browser_download_url') | first }}"
    github_latest_version: "{{ github_release.json.tag_name }}"

- name: Include version tracking tasks
  include_tasks: version_tracking.yml
  vars:
    github_asset_name: "{{ github_asset_name_pattern }}"
    github_version_tracking_file: "/path/to/version_tracking_file"

- name: Download file
  get_url:
    url: "{{ github_download_url }}"
    dest: "{{ github_dest_path }}"
    mode: '{{ github_file_mode | default("0644") }}'
  when: github_version_mismatch | default(true)
  register: github_download_result

- name: Ensure the downloaded file has the proper permissions
  file:
    path: "{{ github_dest_path }}"
    mode: '{{ github_file_mode | default("0644") }}'
    state: file
  when: github_version_mismatch | default(true) and github_download_result is changed
