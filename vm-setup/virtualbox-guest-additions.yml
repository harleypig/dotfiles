---
- name: Install VirtualBox Guest Additions
  hosts: localhost
  become: yes

  vars:
    #iso_path: /usr/share/virtualbox/VBoxGuestAdditions.iso
    mount_path: /mnt/vbox_guest_additions
    vbox_version_url: "https://download.virtualbox.org/virtualbox/LATEST.TXT"
    vbox_iso_base_url: "https://download.virtualbox.org/virtualbox"

  tasks:
    - name: Get VirtualBox version
      command: vboxmanage --version
      register: vbox_version_result
      changed_when: false

    - name: Set VirtualBox version fact
      set_fact:
        vbox_version: "{{ vbox_version_result.stdout | regex_search('^(\\d+\\.\\d+\\.\\d+)') | first }}"

    - name: Download VirtualBox Guest Additions ISO version file
      get_url:
        url: "{{ vbox_version_url }}"
        dest: "/tmp/LATEST.TXT"
        mode: '0644'

    - name: Read VirtualBox Guest Additions ISO version
      command: cat /tmp/LATEST.TXT
      register: vbox_latest_version_result
      changed_when: false

    - name: Set VirtualBox Guest Additions ISO version fact
      set_fact:
        vbox_guest_additions_version: "{{ vbox_latest_version_result.stdout }}"

    - name: Set VirtualBox Guest Additions ISO download URL
      set_fact:
        vbox_guest_additions_iso_url: "{{ vbox_iso_base_url }}/{{ vbox_guest_additions_version }}/VBoxGuestAdditions_{{ vbox_guest_additions_version }}.iso"
        vbox_guest_additions_iso_path: "/tmp/VBoxGuestAdditions_{{ vbox_guest_additions_version }}.iso"

    - name: Download VirtualBox Guest Additions ISO
      get_url:
        url: "{{ vbox_guest_additions_iso_url }}"
        dest: "{{ vbox_guest_additions_iso_path }}"
        mode: '0644'

    - name: Create mount directory for VirtualBox Guest Additions
      file:
        path: "{{ mount_path }}"
        state: directory

    - name: Mount VirtualBox Guest Additions ISO
      ansible.builtin.mount:
        #src: "{{ iso_path }}"
        src: "{{ vbox_guest_additions_iso_path }}"
        path: "{{ mount_path }}"
        fstype: iso9660
        opts: loop
        state: mounted

    - name: Install VirtualBox Guest Additions
      command: "{{ mount_path }}/VBoxLinuxAdditions.run"
      register: vbox_guest_additions_result
      ignore_errors: yes

    - name: Unmount VirtualBox Guest Additions ISO
      ansible.builtin.mount:
        path: "{{ mount_path }}"
        state: unmounted

    - name: Remove mount directory for VirtualBox Guest Additions
      file:
        path: "{{ mount_path }}"
        state: absent
      when: vbox_guest_additions_result is defined and vbox_guest_additions_result.rc != 0

    - name: Reboot the system if installation succeeded
      ansible.builtin.reboot:
      when: vbox_guest_additions_result is defined and vbox_guest_additions_result.rc == 0

    - name: Remove downloaded VirtualBox Guest Additions ISO
      file:
        path: "{{ vbox_guest_additions_iso_path }}"
        state: absent
