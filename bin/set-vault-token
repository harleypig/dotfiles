#!/bin/bash

command -v vault &> /dev/null || {
    echo "Error: vault is required to run this script"
    exit 1
}

declare user="${1:-$USER}"
declare -x VAULT_TOKEN

if command -v expect &> /dev/null && [[ -n $LDAP_PASS ]]; then
    expect <<EOF
    set timeout 10
    log_user 0
    spawn vault login -token-only -method=ldap username=$user
    expect "Password (will be hidden):"
    send "$LDAP_PASS\r"
    expect {
      "Success! You are now authenticated" {
        log_user 1
      "Success! You are now authenticated" {
        set VAULT_TOKEN $expect_out(buffer)
        set env(VAULT_TOKEN) $VAULT_TOKEN
      }
      timeout {
        exit 1
      }
    }
EOF
else
    VAULT_TOKEN="$(vault login -token-only -method=ldap username="$user")" || {
        declare rc=$?
        echo "$VAULT_TOKEN"
        unset VAULT_TOKEN
        return $rc
    }
fi
