#!/bin/bash

# See the 'How to use GIT checkout' section of the README.rst file.

FLEXGET_DIR='/home/harleypig/projects/flexget'
cd $FLEXGET_DIR || { echo "Unable to change to $FLEXGET_DIR, exiting" ; exit 1 ; }

FLEXGET_BIN="${FLEXGET_DIR}/bin"
FLEXUI_DIR="${FLEXGET_DIR}/flexget/ui/v2"

flexget="${FLEXGET_BIN}/flexget"
pip="${FLEXGET_BIN}/pip"

stop_daemon="${flexget} daemon stop"
start_daemon="${flexget} daemon start -d"
upgrade="${pip} install --upgrade -e ${FLEXGET_DIR}"
virtenv="$(which virtualenv) --clear --always-copy ${FLEXGET_DIR}"

cd $FLEXGET_DIR || { echo "Unable to change to $FLEXGET_DIR" ; exit 1 ; }

$stop_daemon

while ( pgrep -x flexget 1> /dev/null 2>&1 ); do
  dots="${dots}."
  echo -ne "waiting for flexget to stop ${dots}\r"
  sleep 1
done

echo

# start clean
git clean -xf

# update flexget
git fetch --all
git pull
$virtenv $FLEXGET_DIR
$upgrade

# update ui
cd $FLEXUI_DIR || { echo "Unable to change to $FLEXUI_DIR, exiting." ; exit 1 ; }

npm install
npm run build

cd $FLEXGET_DIR || { echo "Unable to change to $FLEXGET_DIR, exiting." ; exit 1 ; }
$start_daemon
