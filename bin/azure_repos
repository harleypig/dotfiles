#!/bin/bash

##############################################################################
# Settings

azure_url_pattern="dev.azure.com"
projects_path="$HOME/projects"

declare -A local_repos clone_repos

##############################################################################
# Functions

#-----------------------------------------------------------------------------
warn() { printf '%s\n' "$@" >&2; }
die() { (($#)) && warn "$@"; exit 1 }

#-----------------------------------------------------------------------------
local_repos() {
  while IFS= read -r -d '' gitdir; do
    grep -q "$azure_url_pattern" "$gitdir/config" || continue

    repo_path="${gitdir#$projects_path/}"
    repo_path="${repo_path%/.git}"
    repo_name="${repo_path##*/}"

    [[ -n "${repos[$repo_name]}" ]] && {
      warn "duplicate $repo_name (${repos[$repo_name]}), not adding $repo_path"
      continue
    }

    local_repos[$repo_name]="$repo_path"
  done < <(find "$HOME/projects" -type d -name '.git' -print0)
}

#-----------------------------------------------------------------------------
mk_clone_list() {
  az repos list --output json | jq -r '.[] | .remoteUrl' | while read -r remoteUrl; do
    name=$(basename "$(dirname "$remoteUrl")")

    if [[ -n "${local_repos[$name]}" ]]; then
      continue
    else
      clone_repos[$name]="$remoteUrl"
    fi
  done
}

#-----------------------------------------------------------------------------
mk_clone_list() {
}

##############################################################################
# Main

mk_clone_list
local_repos
