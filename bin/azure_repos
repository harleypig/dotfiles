#!/bin/bash

## If --check-dirty is passed, check for a clean state and exit accordingly
#if ((CHECK_DIRTY)); then
#  ec=0
#  [[ -z $(git status --porcelain 2> /dev/null) ]] && ec=1
#  exit $ec
#fi

##############################################################################
# Settings

azure_url_pattern="dev.azure.com"
projects_path="$HOME/projects"

declare -A local_repos clone_repos

##############################################################################
# Functions

#-----------------------------------------------------------------------------
warn() { printf '%s\n' "$@" >&2; }
die() {
  (($#)) && warn "$@"
  exit 1
}

#-----------------------------------------------------------------------------
usage() {
  msg = "

usage:

"

  (($#)) && msg="${msg}

$@
"

  die "$msg"
}

#-----------------------------------------------------------------------------
# XXX: Change to use ParseParams when it's fixed.

# --no-pull  Don't git pull existing repos. (boolean)
# --no-clone Don't clone any repositories. (boolean)
# --project  Clone repos from this project. If not included then whatever the
#            azure cli is configured to use will be used. (string)
# --exclude  Exclude any repositories listed in this file when cloning repos.
#            One repository per line. (filename)
# --include  Clone only the repositories listed in this file when cloning repos.
#            One repository per line. (filename)
# --help     Displays usage.

parse_params() {
  local param
  local no_pull=0 no_clone=0 project='' exclude='' include=''

  while [[ "$1" != "" ]]; do
    param="$1"
    case $param in
      --no-pull)
        no_pull=1
        ;;
      --no-clone)
        no_clone=1
        ;;
      --project)
        shift
        project="$1"
        ;;
      --exclude)
        shift
        exclude="$1"
        ;;
      --include)
        shift
        include="$1"
        ;;
      --help)
        usage
        ;;
      *)
        usage "Unknown parameter: $param"
        ;;
    esac
    shift
  done
}

#-----------------------------------------------------------------------------
local_repos() {
  local project_path repo_path repo_name

  while IFS= read -r -d '' gitdir; do
    grep -q "$azure_url_pattern" "$gitdir/config" || continue

    project_path="${gitdir%/.git}"
    repo_path="${project_path#$projects_path}"
    repo_name="${repo_path##*/}"

    [[ -n ${repos[$repo_name]} ]] && {
      warn "duplicate $repo_name (${repos[$repo_name]}), not pulling $repo_path"
      continue
    }

    local_repos[$repo_name]="$repo_path"

  done < <(find "$projects_path" -type d -name '.git' -print0)
}

#-----------------------------------------------------------------------------
mk_clone_list() {
  local repos

  readarray -t repos < <(az repos list --output json \
    | jq -r '.[] | .remoteUrl')

  [[ ${PIPESTATUS[0]} -ne 0 ]] && die "Could not run 'az repos list'."

  for repo in "${repos[@]}"; do
    name="${repo##*/}"
    [[ -n ${local_repos[$name]} ]] && continue
    clone_repos[$name]="$remoteUrl"
  done
}

##############################################################################
# Main

cd "$projects_path" || die "Unable to change to $projects_path."

mk_clone_list
local_repos
