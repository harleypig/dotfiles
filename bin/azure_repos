#!/bin/bash

##############################################################################
# Settings

azure_url_pattern="dev.azure.com"
projects_path="$HOME/projects"
clone_path=
no_pull=0
no_clone=0
project=
exclude=
include=

declare -A local_repos clone_repos

##############################################################################
# Functions

#-----------------------------------------------------------------------------
warn() { printf '%s\n' "$@" >&2; }
die() {
  (($#)) && warn "$@"
  exit 1
}

#-----------------------------------------------------------------------------
usage() {
  msg = "

usage:

"

  (($#)) && msg="${msg}

$@
"

  die "$msg"
}

#-----------------------------------------------------------------------------
# XXX: Change to use ParseParams when it's fixed.

parse_params() {
  local param

  # Default project to the current Azure CLI configured project if not provided
  project=$(az config get defaults.group --only-show-errors | jq -r '.value' 2>/dev/null)

  while [[ "$1" != "" ]]; do
    param="$1"
    case $param in
      --no-pull|-np)
        no_pull=1
        ;;
      --no-clone|-nc)
        no_clone=1
        ;;
      --project|-p)
        shift
        ;;
      --exclude)
        shift
        if [[ -f "$1" ]]; then
          exclude="$1"
        else
          die "The file specified with --exclude does not exist: $1"
        fi
        ;;
      --include)
        shift
        if [[ -f "$1" ]]; then
          include="$1"
        else
          die "The file specified with --include does not exist: $1"
        fi
        ;;
      --help|-h)
        usage
        ;;
      *)
        usage "Unknown parameter: $param"
        ;;
    esac
    shift
  done

  ((no_pull)) && ((no_clone)) && usage "--no-pull and --no-clone are mutually exclusive"

  [[ -z $project ]] && {
    project="$(az devops configure --list \
      | grep '^project' | awk '{print $3}')" \
    || die "Unable to detect project in current configuration."
  }

  clone_path="$projects_path/$project"
}

#-----------------------------------------------------------------------------
local_repos() {
  local project_path repo_path repo_name

  while IFS= read -r -d '' gitdir; do
    grep -q "$azure_url_pattern" "$gitdir/config" || continue

    project_path="${gitdir%/.git}"
    repo_path="${project_path#$projects_path}"
    repo_name="${repo_path##*/}"

    [[ -n ${repos[$repo_name]} ]] && {
      warn "duplicate $repo_name (${repos[$repo_name]}), not pulling $repo_path"
      continue
    }

    local_repos[$repo_name]="$repo_path"

    ((no_pull)) && continue

    cd "$project_path" || die "Unable to change to $project_path."
    [[ -n "$(git status --porcelain)" ]] && {
      warn "$repo_name ($repo_path) is dirty, not pulling"
      continue
    }

    git fetch --all 2> /dev/null \
      || warn "Could not fetch $repo_name ($repo_path)"

    git fetch --tags 2> /dev/null \
      || warn "Could not fetch tags for $repo_name ($repo_path)"

  done < <(find "$projects_path" -type d -name '.git' -print0)
}

#-----------------------------------------------------------------------------
clone_repos() {
  local repos

  readarray -t repos < <(az repos list --output json \
    | jq -r '.[] | .remoteUrl')

  [[ ${PIPESTATUS[0]} -ne 0 ]] && die "Could not run 'az repos list'."

  for repo in "${repos[@]}"; do
    name="${repo##*/}"
    [[ -n ${local_repos[$name]} ]] && continue

    cd "$clone_path" || die "Unable to change to $clone_path"

    git clone "$repo"
  done
}

##############################################################################
# Main

parse_params

cd "$projects_path" || die "Unable to change to $projects_path."

local_repos
clone_repos
