#!/usr/bin/bash

# Run docker, npx, or whatever command is needed to start a local mcp server.

###############################################################################
# Setup and sanity

# I don't normally use this, but we want cursor to handle this gracefully
# (ish).
set -euo pipefail

selfname="${0##*/}"

echo "0: $0 ::: $PWD ::: $* <<<" >&2

# Use $DOTFILES for log directory
: "${DOTFILES:?DOTFILES environment variable is not set}"
log_dir="$DOTFILES/.mymcp"

# Create log directory if it doesn't exist
mkdir -p "$log_dir"

# Initialize log file (will be updated with command name once cmd is determined)
# Use first argument as fallback for early warnings
log_timestamp="$(date +%y%m%d-%H%M%S)"
cmd_fallback="${1:-unknown}"
log_file="$log_dir/mymcp-$cmd_fallback-$log_timestamp.log"

declare -A known_cmd

###############################################################################
# Utility Functions

warn() { printf "[$selfname] %s\n" "$@" >> "$log_file" ; }
die() {
  local -i ec="${1:-0}"
  shift
  (($#)) && warn "$@"
  exit $ec
}

#------------------------------------------------------------------------------
docker_run() {
  local opts=('run' '--rm' '-i' "$@")
  warn "docker ${opts[*]}"
  exec docker "${opts[@]}"
}

#------------------------------------------------------------------------------
npx_run() {
  local opts=('-y' "$@")
  warn "npx ${opts[*]}"
  exec npx "${opts[@]}"
}

###############################################################################
# MCP Servers

# https://github.com/github/github-mcp-server/blob/main/docs/server-configuration.md
github() {
  : "${GITHUB_TOKEN:?GITHUB_TOKEN not set}"
  export GITHUB_PERSONAL_ACCESS_TOKEN="$GITHUB_TOKEN"
  docker_run \
    '-e' 'GITHUB_PERSONAL_ACCESS_TOKEN' \
    'ghcr.io/github/github-mcp-server' \
    'stdio' \
    '--dynamic-toolsets' \
    '--tools=get_me,search_code'
}

known_cmd['github']=1

#------------------------------------------------------------------------------
snyk() {
  npx_run 'snyk@latest' 'mcp' '-t' 'stdio'
}

known_cmd['snyk']=1

#------------------------------------------------------------------------------
# https://github.com/Pimzino/spec-workflow-mcp
spec_workflow() {
  npx_run "@pimzino/spec-workflow-mcp@latest" "$@"
}

spec_dashboard() { spec_workflow --dashboard; }
spec_client() { spec_workflow "$@"; }

known_cmd['spec_dashboard']=1
known_cmd['spec_client']=1

#------------------------------------------------------------------------------
(( $# )) || die 2 "Usage: $selfname <${!known_cmd[*]}>"

cmd="$1"
[[ -v "known_cmd[$cmd]" ]] || die 2 "Unknown option: $1"
shift

# Update log file with actual command name
log_file="$log_dir/mymcp-$cmd-$log_timestamp.log"

"$cmd" "$@"
