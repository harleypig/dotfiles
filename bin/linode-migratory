#!/bin/bash

declare -A linodes volumes
declare current_ip current_linode='none'

current_ip="$( ip addr show \
  | grep -oP '(?<=inet\s)\d+(\.\d+){3}' \
  | grep -v '127.0.0.1' \
  | head -n 1)"

echo "Current IP: $current_ip"

echo "NOT READY!"
exit 1

##############################################################################
# Functions
#-----------------------------------------------------------------------------
get_linodes() {
  local raw
  readarray -t raw < <(lin linodes list --format id,label,ipv4 --text --no-headers)

  for line in "${raw[@]}"; do
    read -r lid label ipv4 <<< "$line"
    linodes["$label"]="$lid"
    if [[ "$ipv4" == *"$current_ip"* ]]; then
      current_linode="$label"
    fi
  done
}

#-----------------------------------------------------------------------------
# Modify get_volumes, AI!
#   get linode_label from volumes list
#   if linode_label is not null, then add it to volumes as "$id,$linode_label"
#   change variable id to vid because id is a reserved word
get_volumes() {
  local raw
  readarray -t raw < <(lin volumes list --format id,label --text --no-headers)

  for line in "${raw[@]}"; do
    read -r id label <<< "$line"
    volumes["$label"]="$id"
  done
}

##############################################################################

# Make the filesystem
# Only once!
mkfs.ext4 "/dev/disk/by-id/scsi-0Linode_Volume_migratory"

mkdir /mnt/migratory
mount "/dev/disk/by-id/scsi-0Linode_Volume_migratory" "/mnt/migratory"

