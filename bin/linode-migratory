#!/bin/bash

##############################################################################
# Setup and Sanity

lin="$(command -v linode-cli &> /dev/null)"
[[ -z $lin ]] && {
  echo "linode-cli is required for this script"
  exit 1
}

[[ -z $LINODE_CLI_TOKEN ]] && {
  echo "LINODE_CLI_TOKEN must be set for this script"
  exit 1
}

declare -i DEBUG=0 DRYRUN=0
declare -A linodes volumes
declare current_ip default_linode default_volume

current_ip="$( ip addr show \
  | grep -oP '(?<=inet\s)\d+(\.\d+){3}' \
  | grep -v '127.0.0.1' \
  | head -n 1)"

echo "Current IP: $current_ip"

echo "NOT READY!"
exit 1

##############################################################################
# Functions
#-----------------------------------------------------------------------------
warn() { printf '%s\n' "$@" >&2; }
die() { (($#)) && warn "$@"; exit 1; }
debug() { ((DEBUG)) && warn "$@"; }

#-----------------------------------------------------------------------------
get_linodes() {
  local raw
  readarray -t raw < <($lin linodes list --format id,label,ipv4 --text --no-headers)

  [[ ${#raw[@]} -eq 0 ]] \
    && die "No linodes found. Does the token have the necessary permissions?"

  for line in "${raw[@]}"; do
    read -r lid label ipv4 <<< "$line"
    linodes["$label"]="$lid"
    debug "Added Linode: Label=$label, ID=${linodes[$label]}"

    if [[ "$ipv4" == *"$current_ip"* ]]; then
      default_linode="$label"
      debug "Current linode found: $label"
    fi
  done
}

#-----------------------------------------------------------------------------
get_volumes() {
  local raw
  readarray -t raw < <($lin volumes list --format id,label,linode_label --text --no-headers)

  [[ ${#raw[@]} -eq 0 ]] \
    && die "No volumes found. Does the token have the necessary permissions?"

  for line in "${raw[@]}"; do
    read -r vid label linode_label <<< "$line"

    [[ -n "$linode_label" ]] && vid="$vid,$linode_label"

    volumes["$label"]="$vid"
    debug "Added volume: Label=$label, ID=${linodes[$label]}"

    if [[ ${#raw[@]} -eq 1 ]]; then
      default_volume="$label"
      debug "Default volume: $label"
    fi
  done
}

#-----------------------------------------------------------------------------
setup() {
  get_linodes
  get_volumes
}

#-----------------------------------------------------------------------------
mount_volume() {
  local linode_label="$1"
  local volume_label="$2"

  [[ -z "$linode_label" ]] && die "Linode label is required"
  [[ -z "$volume_label" ]] && die "Volume label is required"

  [[ ! -v linodes["$linode_label"] ]] && die "Linode label '$linode_label' not found"
  [[ ! -v volumes["$volume_label"] ]] && die "Volume label '$volume_label' not found"

  local volume_info="${volumes[$volume_label]}"
  IFS=',' read -r vid linode_mounted <<< "$volume_info"

  if [[ -n "$linode_mounted" ]]; then
    if [[ "$linode_mounted" == "$default_linode" ]]; then
      die "Volume '$volume_label' is already mounted to the default Linode '$default_linode'"
    else
      die "Volume '$volume_label' is already mounted to Linode '$linode_mounted'"
    fi
  fi

  ((DRYRUN)) && return 0

  # Mount volume
  $lin volumes-attach "$vid" "${linodes[$linode_label]}" --config_id 1
  debug "Mounted volume '$volume_label' to Linode '$linode_label'"
}

##############################################################################

# Make the filesystem
# Only once!
#mkfs.ext4 "/dev/disk/by-id/scsi-0Linode_Volume_migratory"

#mkdir /mnt/migratory
#mount "/dev/disk/by-id/scsi-0Linode_Volume_migratory" "/mnt/migratory"

