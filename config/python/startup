import atexit
import os
import readline

# Determine the full path for the history file
if 'PYTHON_HISTORY' in os.environ:
    histfile = os.environ['PYTHON_HISTORY']

elif 'XDG_CONFIG_HOME' in os.environ:
    histfile = os.path.join(os.environ['XDG_CONFIG_HOME'], 'python', 'history')

else:
    histfile = os.path.expanduser('~/.python_history')

# Ensure the history file exists and is readable, otherwise use the default
histdir = os.path.dirname(histfile)

if not os.path.isdir(histdir):
    try:
        os.makedirs(histdir)
    except OSError:
        histfile = os.path.expanduser('~/.python_history')

elif not os.path.isfile(histfile) or not os.access(histfile, os.R_OK):
        histfile = os.path.expanduser('~/.python_history')

try:
    readline.read_history_file(histfile)
    h_len = readline.get_current_history_length()

except FileNotFoundError:
    open(histfile, 'wb').close()
    h_len = 0

def save(prev_h_len, histfile):
  new_h_len = readline.get_current_history_length()
  readline.set_history_length(1000)
  readline.append_history_file(new_h_len - prev_h_len, histfile)

atexit.register(save, h_len, histfile)
