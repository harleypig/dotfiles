name: opencode

on:
  issue_comment:
    types: [created]

# You can set permissions either for everything in this workflow (you would
# add those here) or for individual jobs, as below.
#
# https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax
# Sections: permissions jobsjob_idpermissions
#           how-permissions-are-calculated-for-a-workflow-job
#
# ??? None of these sections are clear on whether the local settings are
#     merged or override the global setting.

concurrency:
  # Currently, since we're only reacting to an issue comment, issue.number
  # below will always be valid. However, if we add a different event above,
  # using run_id will help us fall back to a unique id.
  group: ${{ github.workflow }}-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: true

jobs:
  comment_on_issue:
    name: Comment on issue ${{ github.event.issue.number }}

    if: >-
      contains(fromJson('["OWNER","MEMBER","COLLABORATOR"]'), github.event.comment.author_association) &&
      github.event.comment.user.type != 'Bot' &&
      ! github.even.issue.pull_request &&
      contains(fromJSON('["/oc","/opencode"]'), github.event.comment.body)

    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      # This tests for the variable in the environment, not in secrets.
      # - name: Verify required secrets
      #   run: |
      #     test -n "${OPENROUTER_API_KEY}" || { echo 'OPENROUTER_API_KEY is not set'; exit 1; }
      #   env:
      #     OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}

      - name: Run OpenCode
        uses: sst/opencode/github@latest
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          model: anthropic/claude-sonnet-4-20250514
          # Alternative direct provider if you switch later:
          # model: anthropic/claude-sonnet-4-20250514
          # ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
