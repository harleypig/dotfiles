name: opencode

on:
  issue_comment:
    types: [created]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: true

jobs:
  opencode:
    if: >-
      github.event.comment.user.type != 'Bot' && (
      contains(github.event.comment.body, '/oc') ||
      contains(github.event.comment.body, '/opencode'))
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Verify required secrets
        run: |
          test -n "${OPENROUTER_API_KEY}" || { echo 'OPENROUTER_API_KEY is not set'; exit 1; }
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}

      - name: Clear OpenCode caches (workaround for provider/model changes)
        run: |
          rm -rf ~/.cache/opencode ~/.local/share/opencode || true

      - name: Run OpenCode
        uses: sst/opencode/github@latest
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          model: anthropic/claude-sonnet-4-20250514
          # Alternative direct provider if you switch later:
          # model: anthropic/claude-sonnet-4-20250514
          # ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
