#!/bin/bash

debug "Entering .bash_prompt ..."

# Ideas ripped off and made to fit from:
#   http://wiki.archlinux.org/index.php/Color_Bash_Prompt
#   http://www.termsys.demon.co.uk/vtansi.htm
#   https://gist.github.com/621452
#   https://gist.github.com/623142

# shellcheck disable=SC1091
source_dir "$DOTFILES/.bash_prompt.d"

# Setup color variables
__update_prompt() {

  # don't use local exit_status here because it wipes out PIPESTATUS.
  exit_status=$(__exit_status "${PIPESTATUS[@]}")

  debug "Entering ${FUNCNAME[0]} ..."

  local cwd
  cwd=$(__dir_readable)

  # '\D' is a format specifier for bash prompts. See bash manpage, PROMPTING section.
  local datetime='\D{%a %b %d %Y %T %nDoW: %w DoY: %j Wk: %V Epoch: %s}'

  local pacman_status
  pacman_status=$(__pacman_status)

  local parent
  parent=$(__parent_process)

  local vcs
  vcs=$(__git_status)

  local versionline
  versionline=$(__versions)

  local sysinfo
  sysinfo=$(__sysinfo)

  # Build the prompt.
  # shellcheck disable=SC1117
  {
    if [ "$USER" == 'root' ]; then
      user_color="\[$(ansi fg bright_red)\]"
    else
      user_color="\[$(ansi fg bright_cyan)\]"
    fi

    prompt_color="\[$(ansi fg cyan)\]"
    text_reset="\[$(ansi off)\]"
    text_yellow="\[$(ansi fg yellow)\]"

    # Append the last command, clear the history cache and reread the history file
    PS1="${text_reset}$(
      history -a
      history -c
      history -r
    )"

    PS1+="\n${parent}${parent:+ }${prompt_color}${datetime}"
    PS1+="\n${sysinfo}"
    PS1+="\n${versionline}"
    PS1+="\n${pacman_status}"
    #PS1+="\n\n${text_yellow}(tmux|ctl-a) new -s session_name | switch -t session_name | list-sessions${text_reset}"
    PS1+="\n${user_color}\u${prompt_color}@${text_yellow}\H${prompt_color}: ${cwd}${text_reset}${vcs}"
    PS1+="\n${exit_status} $ "
  }
}

[[ -n $PS1 ]] && PROMPT_COMMAND='__update_prompt'

debug "Exiting .bash_prompt ..."
